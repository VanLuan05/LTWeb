@model QL_BanHoa.DonHang

@{
   
    ViewBag.PageTitle = "Chi tiết đơn hàng #" + Model.MADH;
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="container-fluid mb-5">

    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
        <div>
            <p class="text-muted small mb-0">Ngày đặt: @string.Format("{0:dd/MM/yyyy HH:mm}", Model.NGAYDAT)</p>
        </div>
        <div>
            <a href="@Url.Action("InHoaDon", "Admin", new { id = Model.MADH })" target="_blank" class="btn btn-primary btn-sm shadow-sm me-2">
                <i class="fa fa-print"></i> In Hóa Đơn
            </a>
            <a href="@Url.Action("DonHang", "Admin")" class="btn btn-secondary btn-sm shadow-sm">
                <i class="fa fa-arrow-left"></i> Quay lại
            </a>
        </div>
    </div>

    <div class="card shadow mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-lg-4 col-md-12 border-end mb-3 mb-lg-0">
                    <h6 class="text-primary font-weight-bold text-uppercase mb-3">
                        <i class="fa fa-user me-2"></i>Thông tin người nhận
                    </h6>
                    <div class="ps-3">
                        <p class="mb-2"><strong>Họ tên:</strong> @(Model.NguoiDung != null ? Model.NguoiDung.HOTEN : "Khách vãng lai")</p>
                        <p class="mb-2"><strong>SĐT:</strong> @(Model.NguoiDung != null ? Model.NguoiDung.SODIENTHOAI : "---")</p>
                        <p class="mb-2"><strong>Địa chỉ:</strong> @(Model.DIACHIGIAOHANG ?? Model.NguoiDung.DIACHI)</p>
                        @if (!string.IsNullOrEmpty(Model.GHI_CHU))
                        {
                            <div class="alert alert-warning p-2 small mt-2">
                                <i class="fa fa-sticky-note me-1"></i> <strong>Ghi chú:</strong> @Model.GHI_CHU
                            </div>
                        }
                    </div>
                </div>

                <div class="col-lg-4 col-md-12 border-end mb-3 mb-lg-0">
                    <h6 class="text-info font-weight-bold text-uppercase mb-3">
                        <i class="fa fa-info-circle me-2"></i>Thông tin đơn hàng
                    </h6>
                    <div class="ps-3">
                        <p class="mb-2"><strong>Mã đơn:</strong> #@Model.MADH</p>
                        <p class="mb-2"><strong>Thanh toán:</strong> @(Model.PHUONGTHUCTHANHTOAN ?? "COD")</p>
                        <div class="d-flex align-items-center mb-2">
                            <strong class="me-2">Trạng thái:</strong>
                            @if (Model.TRANG_THAI == "Đang xử lý")
                            {<span class="badge bg-warning text-dark">Đang xử lý</span> }
                            else if (Model.TRANG_THAI == "Đang giao")
                            { <span class="badge bg-info text-white">Đang giao</span> }
                            else if (Model.TRANG_THAI == "Đã giao")
                            { <span class="badge bg-success">Đã giao</span> }
                            else if (Model.TRANG_THAI == "Đã hủy")
                            { <span class="badge bg-danger">Đã hủy</span> }
                            else
                            { <span class="badge bg-secondary">@Model.TRANG_THAI</span>}
                        </div>
                    </div>
                </div>

                <div class="col-lg-4 col-md-12 bg-light rounded p-3">
                    <h6 class="text-danger font-weight-bold text-uppercase mb-3">
                        <i class="fa fa-cog me-2"></i>Cập nhật trạng thái
                    </h6>
                    @using (Html.BeginForm("CapNhatTrangThai", "Admin", FormMethod.Post))
                    {
                        <input type="hidden" name="id" value="@Model.MADH" />

                        <div class="mb-3">
                            <select name="trangThai" class="form-select form-control border-left-danger" style="height: 45px;">
                                <option value="Đang xử lý" @(Model.TRANG_THAI == "Đang xử lý" ? "selected" : "")>⏳ Đang xử lý</option>
                                <option value="Đang giao" @(Model.TRANG_THAI == "Đang giao" ? "selected" : "")>🚚 Đang giao hàng</option>
                                <option value="Đã giao" @(Model.TRANG_THAI == "Đã giao" ? "selected" : "")>✅ Đã giao thành công</option>
                                <option value="Đã hủy" @(Model.TRANG_THAI == "Đã hủy" ? "selected" : "")>❌ Hủy đơn hàng</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-danger btn-block w-100 font-weight-bold py-2">
                            <i class="fa fa-save me-2"></i> CẬP NHẬT NGAY
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Danh sách sản phẩm</h6>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-hover align-middle mb-0">
                    <thead class="bg-light text-center">
                        <tr>
                            <th style="width: 45%;">Sản phẩm</th>
                            <th style="width: 15%;">Đơn giá</th>
                            <th style="width: 10%;">SL</th>
                            <th style="width: 30%;">Thành tiền</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{ decimal tongCong = 0; }
                        @foreach (var item in Model.ChiTietDonHangs)
                        {
                            decimal thanhTien = (decimal)(item.SOLUONG * item.THANHTIEN);
                            tongCong += thanhTien;

                            <tr>
                                <td class="p-3">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3 flex-shrink-0" style="width: 60px; height: 60px;">
                                            <img src="~/Content/hinhanh/@item.SanPham.URL_ANH" class="img-fluid rounded border" style="width: 100%; height: 100%; object-fit: cover;">
                                        </div>
                                        <div>
                                            <div class="font-weight-bold text-dark">@item.SanPham.TENSP</div>
                                            <small class="text-muted">Mã SP: #@item.MASP</small>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-center font-weight-bold">@string.Format("{0:#,###}", item.THANHTIEN)</td>
                                <td class="text-center">
                                    <span class="badge badge-light border text-dark p-2">x @item.SOLUONG</span>
                                </td>
                                <td class="text-center font-weight-bold text-primary fs-5">
                                    @string.Format("{0:#,###} đ", thanhTien)
                                </td>
                            </tr>
                        }
                    </tbody>
                    <tfoot class="bg-light">
                        <tr>
                            <td colspan="3" class="text-right font-weight-bold text-uppercase p-3">Tổng thanh toán:</td>
                            <td class="text-center font-weight-bold text-danger fs-4 p-3">
                                @string.Format("{0:#,###} đ", Model.TONGTIEN)
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>