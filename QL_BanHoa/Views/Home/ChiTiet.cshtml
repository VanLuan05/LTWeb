@model QL_BanHoa.SanPham
@{
    ViewBag.Title = "Chi Tiết Sản Phẩm";
    ViewBag.PageTitle = "Chi tiết sản phẩm"; // Dùng cho Admin layout nếu cần
    Layout = "~/Views/Shared/_Layout.cshtml";

    // 1. Tính toán giá bán hiện tại (đã trừ khuyến mãi nếu có) để dùng cho JS
    decimal giaGoc = Model.GIA.HasValue ? (decimal)Model.GIA.Value : 0;
    decimal giaBan = giaGoc;
    if (Model.MAKM != null && Model.KHUYENMAI != null)
    {
        giaBan = giaGoc - (giaGoc * (decimal)Model.KHUYENMAI.PHANTRAMGIAM / 100);
    }
}

<div class="container my-3">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")">Trang chủ</a></li>
            <li class="breadcrumb-item"><a href="@Url.Action("Index", "SanPham")">Sản phẩm</a></li>
            <li class="breadcrumb-item active" aria-current="page">@Model.TENSP</li>
        </ol>
    </nav>
</div>

<section id="product-detail" class="container my-5">
    <div class="row g-4">
        <div class="col-lg-6">
            <div class="main-image-container mb-3 border rounded shadow-sm">
                <img src="~/Content/hinhanh/@Model.URL_ANH" class="img-fluid w-100" alt="@Model.TENSP" style="object-fit: contain; max-height: 500px;">
            </div>
        </div>

        <div class="col-lg-6">
            <h1 class="mb-3" style="color:#036b03;">@Model.TENSP</h1>
            <p class="text-muted small">Mã SP: @Model.MASP | Tình trạng: <span class="text-success fw-bold">@Model.TRANGTHAI</span></p>

            <div class="price-section mb-4">
                @if (Model.MAKM != null && Model.KHUYENMAI != null)
                {
                    <span class="text-decoration-line-through text-secondary me-2 h4">@string.Format("{0:#,###}", giaGoc)₫</span>
                    <span id="displayPrice" class="text-danger h2 fw-bold" style="color: #d13364 !important;">@string.Format("{0:#,###}", giaBan)₫</span>
                    <span class="badge bg-danger ms-2">-@Model.KHUYENMAI.PHANTRAMGIAM%</span>
                }
                else
                {
                    <span id="displayPrice" class="text-danger h2 fw-bold" style="color: #d13364 !important;">@string.Format("{0:#,###}", giaBan)₫</span>
                }
            </div>

            <p class="lead mb-4" style="font-size: 0.95rem;">@Model.MOTA</p>

            <div class="product-options mb-4">
                <h5 class="fw-bold">Tùy Chọn Kích Cỡ:</h5>
                <div class="btn-group mb-3" role="group">
                    <input type="radio" class="btn-check" name="size" id="sizeS" autocomplete="off" checked>
                    <label class="btn btn-outline-secondary" for="sizeS">Bó Nhỏ</label>
                    <input type="radio" class="btn-check" name="size" id="sizeM" autocomplete="off">
                    <label class="btn btn-outline-secondary" for="sizeM">Bó Trung</label>
                    <input type="radio" class="btn-check" name="size" id="sizeL" autocomplete="off">
                    <label class="btn btn-outline-secondary" for="sizeL">Bó Lớn</label>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Ngày Giao Hàng Dự Kiến:</label>
                    <input type="date" class="form-control w-50" id="deliveryDate" value="@DateTime.Now.AddDays(1).ToString("yyyy-MM-dd")">
                </div>
            </div>

            @using (Html.BeginForm("ThemGioHang", "GioHang", FormMethod.Post))
            {
                <input type="hidden" name="MaSP" value="@Model.MASP" />
                <input type="hidden" name="url" value="@Request.Url.ToString()" />

                <div class="d-flex align-items-center mb-4">
                    <div class="input-group quantity-control me-3" style="width: 140px;">
                        <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity(-1)">-</button>
                        <input type="number" class="form-control text-center" name="SoLuong" value="1" min="1" id="quantityInput" onchange="updatePrice()">
                        <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity(1)">+</button>
                    </div>

                    <button type="submit" class="btn btn-success fw-bold px-4 py-2">
                        <i class="fa fa-shopping-cart me-2"></i> THÊM VÀO GIỎ
                    </button>
                </div>
            }

            <button class="btn btn-lg fw-bold w-100 text-white" style="background-color: #d13364;">
                MUA NGAY - GIAO NHANH 90 PHÚT
            </button>
        </div>
    </div>

    <div class="row mt-5">
        <div class="col-12">
            <h4 class="mb-3 pb-2 border-bottom" style="color:#036b03;">CHI TIẾT SẢN PHẨM & DỊCH VỤ</h4>
            <ul class="nav nav-tabs" id="productTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="description-tab" data-bs-toggle="tab" data-bs-target="#description" type="button" role="tab">Mô Tả Chi Tiết</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="shipping-tab" data-bs-toggle="tab" data-bs-target="#shipping" type="button" role="tab">Chính Sách Giao Hàng</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="review-tab" data-bs-toggle="tab" data-bs-target="#review" type="button" role="tab">Đánh Giá (0)</button>
                </li>
            </ul>
            <div class="tab-content p-4 border border-top-0 bg-light rounded-bottom">
                <div class="tab-pane fade show active" id="description" role="tabpanel">
                    <p>@Model.MOTA</p>
                    <p><strong>Lưu ý:</strong> Sản phẩm thực tế có thể khác đôi chút so với hình ảnh do đặc tính của hoa tươi và tính chất thủ công.</p>
                </div>
                <div class="tab-pane fade" id="shipping" role="tabpanel">
                    <p><strong>Giao hoa nhanh:</strong> Trong 90-120 phút tại nội thành TP.HCM.</p>
                    <p><strong>Phí ship:</strong> Miễn phí vận chuyển cho đơn hàng trên 300k tại các quận trung tâm.</p>
                </div>
                <div class="tab-pane fade" id="review" role="tabpanel">
                    <p>Chưa có đánh giá nào cho sản phẩm này.</p>
                </div>
            </div>
        </div>
    </div>
    </section>

<script>
    // Lấy giá bán từ biến Server C# đưa vào biến JS (chuyển sang số nguyên để tính toán)
    var donGia = @giaBan.ToString("0"); 

    // Hàm cập nhật số lượng khi bấm nút +/-
    function updateQuantity(change) {
        var input = document.getElementById('quantityInput');
        var currentVal = parseInt(input.value);
        
        if (isNaN(currentVal)) currentVal = 1;
        
        var newVal = currentVal + change;
        if (newVal < 1) newVal = 1; // Không cho nhỏ hơn 1
        
        input.value = newVal;
        
        // Gọi hàm tính lại giá
        updatePrice();
    }

    // Hàm tính lại tổng tiền hiển thị
    function updatePrice() {
        var input = document.getElementById('quantityInput');
        var soLuong = parseInt(input.value);
        
        if (isNaN(soLuong) || soLuong < 1) {
            soLuong = 1;
        }

        var thanhTien = donGia * soLuong;
        
        // Format tiền tệ kiểu Việt Nam (ví dụ: 100.000₫)
        var formattedPrice = thanhTien.toLocaleString('vi-VN') + '₫';
        
        // Cập nhật text vào thẻ span hiển thị giá
        var displayElement = document.getElementById('displayPrice');
        if (displayElement) {
            displayElement.innerText = formattedPrice;
        }
    }
</script>